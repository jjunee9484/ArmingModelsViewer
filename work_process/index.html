<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Process Viewer</title>
    <style>
        :root {
            --accent: #4a90e2;
            --bg-ui: rgba(15, 15, 15, 0.7);
            --glass: blur(15px);
            --text: rgba(255, 255, 255, 0.9);
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            background: #2c3e50; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        }

        /* ê³µí†µ UI ìš”ì†Œ - ê³ ì • ë°°ì¹˜ ë° ì• ë‹ˆë©”ì´ì…˜ */
        .ui-element {
            position: fixed;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                        transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ì¡°ì‘ ì‹œ ë‚˜íƒ€ë‚˜ëŠ” ìƒíƒœ */
        .ui-element.is-visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* ì™¼ìª½ ìƒë‹¨: ì¹´ë©”ë¼ */
        #ui-top-left {
            top: 25px;
            left: 25px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transform: translateY(-10px);
        }
        #ui-top-left.is-visible { transform: translateY(0); }

        /* ì˜¤ë¥¸ìª½ ìƒë‹¨: ë¦¬ì…‹ */
        #ui-top-right {
            top: 25px;
            right: 25px;
            transform: translateY(-10px);
        }
        #ui-top-right.is-visible { transform: translateY(0); }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°”: ì¬ìƒ ë° íƒ€ì„ë¼ì¸ */
        #ui-bottom {
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(15px);
            width: 80%;
            max-width: 600px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--bg-ui);
            padding: 12px 22px;
            border-radius: 24px;
            backdrop-filter: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #ui-bottom.is-visible { transform: translateX(-50%) translateY(0); }

        /* ë²„íŠ¼ ë° ë ˆì´ë¸” ê³µí†µ ìŠ¤íƒ€ì¼ */
        .btn-group { display: flex; gap: 8px; }
        
        button, label { 
            padding: 8px 14px; 
            cursor: pointer; 
            background: var(--bg-ui); 
            color: var(--text); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 10px; 
            font-weight: 600; 
            font-size: 11px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            backdrop-filter: var(--glass); 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:hover, label:hover { 
            background: var(--accent); 
            color: white; 
            border-color: var(--accent);
        }

        button:disabled { opacity: 0.2; cursor: not-allowed; }
        .active { background: var(--accent) !important; color: white; border-color: var(--accent); }

        /* ì¬ìƒ/ì¼ì‹œì •ì§€ ë²„íŠ¼ */
        #playPauseBtn {
            background: none; border: none; font-size: 18px; color: white; 
            cursor: pointer; padding: 0; min-width: 30px;
        }

        /* ì„¸ë ¨ëœ ìŠ¬ë¼ì´ë” ì¡°ì ˆ */
        #timeline {
            flex-grow: 1; cursor: pointer; height: 4px; appearance: none;
            background: rgba(255, 255, 255, 0.15); border-radius: 2px; outline: none;
        }
        #timeline::-webkit-slider-thumb {
            appearance: none; width: 14px; height: 14px; background: white; 
            border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.5); border: 2px solid var(--accent);
        }

        .hide-cursor { cursor: none; }

        /* ë¡œë”© ì•ˆë‚´ */
        #loader-msg { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-weight: bold; font-size: 14px; pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="loader-msg">ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="ui-top-left" class="ui-element">
        <div class="btn-group">
            <button id="blenderCamBtn" disabled>FIXED CAM</button>
            <button id="freeCamBtn" class="active">FREE CAM</button>
        </div>
    </div>

    <div id="ui-top-right" class="ui-element">
        <button id="resetBtn">ğŸ”„ RESET VIEW</button>
    </div>

    <div id="ui-bottom" class="ui-element">
        <button id="playPauseBtn">â¸</button>
        <input type="range" id="timeline" min="0" max="100" value="0" step="0.001">
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { OutlineEffect } from 'three/addons/effects/OutlineEffect.js';

        let scene, renderer, effect, controls, mixer, clock, currentModel, currentAction;
        let defaultCamera, blenderCamera, activeCamera;
        let initialPos = new THREE.Vector3(), initialTarget = new THREE.Vector3();
        let isResetting = false, isPlaying = true, isScrubbing = false;

        // UI ìˆ¨ê¹€ íƒ€ì´ë¨¸ ë³€ìˆ˜
        let uiTimer;
        const uiElements = document.querySelectorAll('.ui-element');
        const timeline = document.getElementById('timeline');
        const playBtn = document.getElementById('playPauseBtn');

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0X5d8aa8);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            effect = new OutlineEffect(renderer);

            defaultCamera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 5000);
            activeCamera = defaultCamera;

            // ì¡°ëª… ì„¤ì • (íˆ° ì‰ì´ë”© ìµœì í™”)
            scene.add(new THREE.AmbientLight(0xffffff, 3));
            const sun = new THREE.DirectionalLight(0xffffff, 3);
            sun.position.set(5, 15, 10);
            scene.add(sun);

            controls = new OrbitControls(defaultCamera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            clock = new THREE.Clock();

            // --- ìƒí˜¸ì‘ìš© ë° UI ìë™ ìˆ¨ê¹€ ë¡œì§ ---
            const triggerUI = () => showUI();
            window.addEventListener('mousemove', triggerUI);
            window.addEventListener('mousedown', triggerUI);
            window.addEventListener('touchstart', triggerUI);

            // ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('freeCamBtn').onclick = () => switchCamera('free');
            document.getElementById('blenderCamBtn').onclick = () => switchCamera('blender');
            document.getElementById('resetBtn').onclick = () => { isResetting = true; triggerUI(); };

            playBtn.onclick = () => {
                isPlaying = !isPlaying;
                playBtn.innerText = isPlaying ? "â¸" : "â–¶";
            };

            // íƒ€ì„ë¼ì¸ ìŠ¤í¬ëŸ¬ë¹™(ë“œë˜ê·¸) ì²˜ë¦¬
            timeline.onmousedown = () => { isScrubbing = true; };
            timeline.onmouseup = () => { isScrubbing = false; };
            timeline.oninput = (e) => {
                if (!currentAction) return;
                mixer.setTime(parseFloat(e.target.value));
                isPlaying = false;
                playBtn.innerText = "â–¶";
            };


            // URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë¡œì§
            const urlParams = new URLSearchParams(window.location.search);
            const modelName = urlParams.get('model');

            if (modelName) {
                loadModelFromURL(modelName);
            } else {
                document.getElementById('loader-msg').innerText = "URLì— ?model=íŒŒì¼ëª… ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            }


            window.addEventListener('resize', onWindowResize);
            showUI(); // ì‹œì‘ ì‹œ UI í‘œì‹œ
        }

        function showUI() {
            clearTimeout(uiTimer);
            uiElements.forEach(el => el.classList.add('is-visible'));
            document.body.classList.remove('hide-cursor');

            // ëª‡ ì´ˆ í›„ ìˆ¨ê¹€ (ìŠ¬ë¼ì´ë” ì¡°ì‘ ì¤‘ì´ê±°ë‚˜ ë©ˆì¶°ìˆì„ ë•ŒëŠ” ìœ ì§€)
            uiTimer = setTimeout(() => {
                if (!isScrubbing) {
                    uiElements.forEach(el => el.classList.remove('is-visible'));
                    document.body.classList.add('hide-cursor');
                }
            }, 250);
        }

        function loadModelFromURL(name) {
            const loader = new GLTFLoader();
            const filePath = `${name}.glb`; // í´ë” ë‚´ì˜ íŒŒì¼ ê²½ë¡œ

            loader.load(
                filePath,
                (gltf) => {
                    document.getElementById('loader-msg').style.display = 'none';
                    applyModel(gltf); // íŒŒì¼ ë¡œë“œ ì„±ê³µ ì‹œ applyModel ì‹¤í–‰
                },
                (xhr) => {
                    const percent = Math.round((xhr.loaded / xhr.total) * 100);
                    document.getElementById('loader-msg').innerText = `Loading: ${percent}%`;
                },
                (error) => {
                    console.error(error);
                    document.getElementById('loader-msg').innerText = "íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                }
            );
        }

        function applyModel(gltf) {
            if (currentModel) scene.remove(currentModel);
            
            currentModel = gltf.scene;

            // íˆ° ì‰ì´ë”© ì¬ì§ˆ ì ìš©
            currentModel.traverse(c => {
                if (c.isMesh) {
                    c.material = new THREE.MeshToonMaterial({ 
                        color: c.material.color, 
                        map: c.material.map 
                    });
                }
            });
            scene.add(currentModel);

            // ì¹´ë©”ë¼ ì´ˆê¸° ë·°í¬íŠ¸ ìë™ ê³„ì‚°
            const box = new THREE.Box3().setFromObject(currentModel);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            
            initialTarget.copy(center);
            initialPos.set(center.x, center.y + size.y * 0.5, -(center.z + maxDim * 1));
            
            controls.target.copy(initialTarget);
            defaultCamera.position.copy(initialPos);
            controls.update();

            // ì• ë‹ˆë©”ì´ì…˜ ë¯¹ì„œ ì´ˆê¸°í™”
            mixer = new THREE.AnimationMixer(currentModel);
            if (gltf.animations.length > 0) {
                currentAction = mixer.clipAction(gltf.animations[0]);
                currentAction.play();
                timeline.max = gltf.animations[0].duration;
                timeline.value = 0;
                isPlaying = true;
                playBtn.innerText = "â¸";
            }

            // ë¸”ë Œë” ì¹´ë©”ë¼ íƒ‘ì¬ ì—¬ë¶€ í™•ì¸
            if (gltf.cameras.length > 0) {
                blenderCamera = gltf.cameras[0];
                blenderCamera.aspect = window.innerWidth / window.innerHeight;
                blenderCamera.updateProjectionMatrix();
                document.getElementById('blenderCamBtn').disabled = false;
                switchCamera('blender');
            } else {
                document.getElementById('blenderCamBtn').disabled = true;
                switchCamera('free');
            }
        }

        function switchCamera(type) {
            const fBtn = document.getElementById('freeCamBtn');
            const bBtn = document.getElementById('blenderCamBtn');
            const rBtn = document.getElementById('ui-top-right');

            if (type === 'free') {
                activeCamera = defaultCamera;
                controls.enabled = true;
                fBtn.classList.add('active');
                bBtn.classList.remove('active');
                rBtn.style.display = 'block';
            } else {
                activeCamera = blenderCamera;
                controls.enabled = false;
                bBtn.classList.add('active');
                fBtn.classList.remove('active');
                rBtn.style.display = 'none';
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            
            // ì• ë‹ˆë©”ì´ì…˜ ë° íƒ€ì„ë¼ì¸ ë™ê¸°í™”
            if (mixer && isPlaying) {
                mixer.update(delta);
                if (currentAction) {
                    // ë£¨í”„ ì‹œ ìŠ¬ë¼ì´ë” ê°’ ìì—°ìŠ¤ëŸ½ê²Œ ê°±ì‹ 
                    timeline.value = mixer.time % currentAction.getClip().duration;
                }
            }

            // ì‹œì  ë¦¬ì…‹ ì• ë‹ˆë©”ì´ì…˜ (ë¶€ë“œëŸ¬ìš´ ì´ë™)
            if (isResetting) {
                defaultCamera.position.lerp(initialPos, 0.1);
                controls.target.lerp(initialTarget, 0.1);
                if (defaultCamera.position.distanceTo(initialPos) < 0.01) {
                    isResetting = false;
                }
            }
            if (controls.enabled) controls.update();

            effect.render(scene, activeCamera);
        }

        // ë¦¬ì…‹ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì´ì—ˆë‹¤ë©´ ì¦‰ì‹œ ì¤‘ë‹¨!
        controls.addEventListener('start', () => {
            isResetting = false; });

        function onWindowResize() {
            const w = window.innerWidth, h = window.innerHeight;
            renderer.setSize(w, h);
            defaultCamera.aspect = w / h;
            defaultCamera.updateProjectionMatrix();
            if (blenderCamera) {
                blenderCamera.aspect = w / h;
                blenderCamera.updateProjectionMatrix();
            }
        }
    </script>
</body>
</html>