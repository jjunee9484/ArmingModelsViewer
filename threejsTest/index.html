<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Blender Viewer - Dual Outline & Camera Control</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 10; display: flex; flex-direction: column; gap: 10px; }
        .btn-group { display: flex; gap: 5px; }
        button, label { 
            padding: 10px 15px; cursor: pointer; background: rgba(40, 40, 40, 0.9); color: white; 
            border: 1px solid #444; border-radius: 6px; font-weight: bold; font-size: 12px; transition: 0.3s;
        }
        button:hover, label:hover { background: #555; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        .active { background: #4a90e2 !important; border-color: #6fb1fc !important; }
        #fileInput { display: none; }
        .upload-btn { background: #27ae60 !important; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="btn-group">
            <input type="file" id="fileInput" accept=".glb,.gltf">
            <label for="fileInput" class="upload-btn">ðŸ“‚ OPEN GLB</label>
        </div>
        <div class="btn-group">
            <button id="blenderCamBtn" disabled>FIXED CAM</button>
            <button id="freeCamBtn" class="active">FREE CAM</button>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let scene, renderer, controls, mixer, clock, currentModel;
        let defaultCamera, blenderCamera, activeCamera;

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            const ambient = new THREE.AmbientLight(0xffffff, 2.5); // ì „ì²´ ë°ê¸° ëŒ€í­ ìƒìŠ¹
            scene.add(ambient);
            
            const direct = new THREE.DirectionalLight(0xffffff, 1.0); // í•˜ì´ë¼ì´íŠ¸ ì¶”ê°€
            direct.position.set(10, 10, 10);
            scene.add(direct);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // ê¸°ë³¸ ìžìœ  ì¹´ë©”ë¼ ì„¤ì •
            defaultCamera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            defaultCamera.position.set(5, 5, 5);
            activeCamera = defaultCamera;

            controls = new OrbitControls(defaultCamera, renderer.domElement);
            controls.enableDamping = true;

            scene.add(new THREE.AmbientLight(0xffffff, 2.0));
            clock = new THREE.Clock();

            // UI ì´ë²¤íŠ¸
            document.getElementById('freeCamBtn').onclick = () => switchCamera('free');
            document.getElementById('blenderCamBtn').onclick = () => switchCamera('blender');
            document.getElementById('fileInput').onchange = (e) => loadLocalFile(e);

            window.addEventListener('resize', onWindowResize);
        }

        function loadModel(data) {
            const loader = new GLTFLoader();
            if (currentModel) scene.remove(currentModel);
            if (mixer) mixer.stopAllAction();

            loader.parse(data, '', (gltf) => {
                currentModel = gltf.scene;

                // --- ì´ì¤‘ ì™¸ê³½ì„  ë¡œì§ ì ìš© ---
                currentModel.traverse((node) => {
                    if (node.isMesh) {
                        const edges = new THREE.EdgesGeometry(node.geometry, 30);
                        
                        const bLine = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ 
                            color: 0x000000, transparent: true, opacity: 0.5 
                        }));
                        const wLine = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ 
                            color: 0xffffff, transparent: true, opacity: 0.5 
                        }));

                        node.add(bLine);
                        node.add(wLine);
                    }
                });

                scene.add(currentModel);

                // ì• ë‹ˆë©”ì´ì…˜ ì„¤ì •
                mixer = new THREE.AnimationMixer(currentModel);
                gltf.animations.forEach(clip => mixer.clipAction(clip).play());

                // Blender ì¹´ë©”ë¼ í™•ì¸
                if (gltf.cameras.length > 0) {
                    blenderCamera = gltf.cameras[0];
                    blenderCamera.aspect = window.innerWidth / window.innerHeight;
                    blenderCamera.updateProjectionMatrix();
                    document.getElementById('blenderCamBtn').disabled = false;
                } else {
                    blenderCamera = null;
                    document.getElementById('blenderCamBtn').disabled = true;
                    switchCamera('free');
                }
            });
        }

        function switchCamera(type) {
            const fBtn = document.getElementById('freeCamBtn');
            const bBtn = document.getElementById('blenderCamBtn');

            if (type === 'free') {
                activeCamera = defaultCamera;
                controls.enabled = true;
                fBtn.classList.add('active');
                bBtn.classList.remove('active');
            } else if (type === 'blender' && blenderCamera) {
                activeCamera = blenderCamera;
                controls.enabled = false; // ê³ ì • ì¹´ë©”ë¼ëŠ” ì»¨íŠ¸ë¡¤ ë¹„í™œì„±í™”
                bBtn.classList.add('active');
                fBtn.classList.remove('active');
            }
        }

        function onWindowResize() {
            const w = window.innerWidth;
            const h = window.innerHeight;
            renderer.setSize(w, h);
            defaultCamera.aspect = w / h;
            defaultCamera.updateProjectionMatrix();
            if (blenderCamera) {
                blenderCamera.aspect = w / h;
                blenderCamera.updateProjectionMatrix();
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);
            if (controls.enabled) controls.update();
            renderer.render(scene, activeCamera);
        }

        function loadLocalFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => loadModel(e.target.result);
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>